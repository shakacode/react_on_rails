#!/usr/bin/env bash
#
# bin/setup - Unified development environment setup for React on Rails
#
# This script installs all dependencies across all directories in the monorepo,
# making it easy for new contributors to get started quickly.
#
# Usage:
#   bin/setup         # Full setup of all packages
#   bin/setup --help  # Show this help message
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory (for running from anywhere)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

show_help() {
  echo "Usage: bin/setup [OPTIONS]"
  echo ""
  echo "Sets up the React on Rails development environment by installing"
  echo "all dependencies across the monorepo."
  echo ""
  echo "Options:"
  echo "  --help    Show this help message"
  echo ""
  echo "This script will:"
  echo "  1. Install root pnpm and bundle dependencies"
  echo "  2. Build the node package"
  echo "  3. Set up react_on_rails/spec/dummy"
  echo "  4. Set up react_on_rails_pro (if present)"
  echo "  5. Set up react_on_rails_pro/spec/dummy (if present)"
  echo "  6. Set up react_on_rails_pro/spec/execjs-compatible-dummy (if present)"
}

print_step() {
  echo -e "\n${BLUE}==>${NC} ${GREEN}$1${NC}"
}

print_warning() {
  echo -e "${YELLOW}Warning:${NC} $1"
}

print_error() {
  echo -e "${RED}Error:${NC} $1"
}

print_success() {
  echo -e "${GREEN}âœ“${NC} $1"
}

check_prerequisites() {
  local missing=()

  if ! command -v pnpm &> /dev/null; then
    missing+=("pnpm")
  fi

  if ! command -v bundle &> /dev/null; then
    missing+=("bundler")
  fi

  if ! command -v node &> /dev/null; then
    missing+=("node")
  fi

  if ! command -v ruby &> /dev/null; then
    missing+=("ruby")
  fi

  if [ ${#missing[@]} -ne 0 ]; then
    print_error "Missing required tools: ${missing[*]}"
    echo ""
    echo "Please install the following before running this script:"
    for tool in "${missing[@]}"; do
      case $tool in
        pnpm)
          echo "  - pnpm: https://pnpm.io/installation"
          ;;
        bundler)
          echo "  - bundler: gem install bundler"
          ;;
        node)
          echo "  - node: https://nodejs.org/ (or use nvm/nodenv)"
          ;;
        ruby)
          echo "  - ruby: https://www.ruby-lang.org/ (or use rvm/rbenv)"
          ;;
      esac
    done
    exit 1
  fi
}

install_dependencies() {
  local dir="$1"
  local name="$2"

  if [ ! -d "$dir" ]; then
    print_warning "Directory not found: $dir (skipping)"
    return 0
  fi

  print_step "Setting up $name..."
  cd "$dir"

  # Install Ruby dependencies if Gemfile exists
  if [ -f "Gemfile" ]; then
    echo "  Installing Ruby dependencies..."
    if bundle check &> /dev/null; then
      print_success "Ruby dependencies already satisfied"
    else
      bundle install
      print_success "Ruby dependencies installed"
    fi
  fi

  # Install JS dependencies if package.json exists
  if [ -f "package.json" ]; then
    echo "  Installing JavaScript dependencies..."
    pnpm install
    print_success "JavaScript dependencies installed"
  fi

  cd "$ROOT_DIR"
}

main() {
  # Handle --help
  if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    show_help
    exit 0
  fi

  echo -e "${GREEN}Setting up React on Rails development environment...${NC}"
  echo ""

  cd "$ROOT_DIR"

  # Check prerequisites
  print_step "Checking prerequisites..."
  check_prerequisites
  print_success "All prerequisites found"

  # Root dependencies
  install_dependencies "$ROOT_DIR" "root directory"

  # Build node package
  print_step "Building node package..."
  rake node_package
  print_success "Node package built"

  # react_on_rails/spec/dummy
  install_dependencies "$ROOT_DIR/react_on_rails/spec/dummy" "react_on_rails/spec/dummy"

  # react_on_rails_pro (if present)
  if [ -d "$ROOT_DIR/react_on_rails_pro" ]; then
    install_dependencies "$ROOT_DIR/react_on_rails_pro" "react_on_rails_pro"

    # react_on_rails_pro/spec/dummy
    install_dependencies "$ROOT_DIR/react_on_rails_pro/spec/dummy" "react_on_rails_pro/spec/dummy"

    # react_on_rails_pro/spec/execjs-compatible-dummy
    install_dependencies "$ROOT_DIR/react_on_rails_pro/spec/execjs-compatible-dummy" "react_on_rails_pro/spec/execjs-compatible-dummy"
  fi

  echo ""
  echo -e "${GREEN}========================================${NC}"
  echo -e "${GREEN}Setup complete!${NC}"
  echo -e "${GREEN}========================================${NC}"
  echo ""
  echo "You can now run:"
  echo "  rake              # Run all tests"
  echo "  rake lint         # Run linters"
  echo "  rake all_but_examples  # Run tests (excluding generator examples)"
  echo ""
  echo "For more information, see CONTRIBUTING.md"
}

main "$@"
