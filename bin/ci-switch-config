#!/usr/bin/env bash
# Switch between CI test configurations locally
#
# Usage:
#   bin/ci-switch-config minimum   # Ruby 3.2, Node 20, minimum deps
#   bin/ci-switch-config latest    # Ruby 3.4, Node 22, latest deps
#   bin/ci-switch-config status    # Show current configuration

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
  echo -e "${BLUE}==>${NC} $1"
}

print_success() {
  echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
  echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
  echo -e "${RED}✗${NC} $1"
}

check_version_manager() {
  if command -v mise &> /dev/null; then
    echo "mise"
  elif command -v asdf &> /dev/null; then
    echo "asdf"
  elif command -v rvm &> /dev/null && command -v nvm &> /dev/null; then
    echo "rvm+nvm"
  elif command -v rvm &> /dev/null; then
    echo "rvm"
  elif command -v nvm &> /dev/null; then
    echo "nvm"
  else
    print_error "No version manager found. Please install one of:"
    echo "  mise (recommended): https://mise.jdx.dev/"
    echo "  asdf:               https://asdf-vm.com/"
    echo "  rvm + nvm:          https://rvm.io/ + https://github.com/nvm-sh/nvm"
    exit 1
  fi
}

set_ruby_version() {
  local version="$1"
  local version_manager="$2"

  case "$version_manager" in
    mise|asdf)
      # Handled via .tool-versions
      ;;
    rvm|rvm+nvm)
      print_header "Setting Ruby $version with rvm"
      # Check if version exists using rvm list rubies for consistent output
      # Anchor to start of line to avoid false matches (e.g., 3.2.8 shouldn't match 13.2.8)
      # Allow optional leading whitespace and ruby- prefix, no end anchor to allow patch suffixes
      if ! rvm list rubies | grep -qE "^[[:space:]]*(ruby-)?${version}"; then
        print_warning "Ruby $version not installed. Installing..."
        if ! rvm install "$version"; then
          print_error "Failed to install Ruby $version with rvm"
          print_warning "Make sure rvm is properly configured. Try running: source ~/.rvm/scripts/rvm"
          exit 1
        fi
      fi
      if ! rvm use "$version"; then
        print_error "Failed to switch to Ruby $version"
        print_warning "Make sure rvm is properly configured. Try running: source ~/.rvm/scripts/rvm"
        exit 1
      fi
      print_success "Switched to Ruby $version"
      ;;
    nvm)
      print_error "Cannot set Ruby version: nvm doesn't manage Ruby"
      echo "Please install one of the following to manage Ruby versions:"
      echo "  - rvm:  https://rvm.io/"
      echo "  - mise: https://mise.jdx.dev/ (recommended, manages both Ruby and Node)"
      echo "  - asdf: https://asdf-vm.com/ (manages both Ruby and Node)"
      exit 1
      ;;
  esac
}

set_node_version() {
  local version="$1"
  local version_manager="$2"

  case "$version_manager" in
    mise|asdf)
      # Handled via .tool-versions
      ;;
    nvm|rvm+nvm)
      print_header "Setting Node $version with nvm"

      # Source nvm if not already loaded - try multiple common locations
      if ! command -v nvm &> /dev/null; then
        # Try standard nvm location
        if [ -s "$HOME/.nvm/nvm.sh" ]; then
          export NVM_DIR="$HOME/.nvm"
          \. "$NVM_DIR/nvm.sh"
        # Try Homebrew location (macOS)
        elif [ -s "/opt/homebrew/opt/nvm/nvm.sh" ]; then
          export NVM_DIR="/opt/homebrew/opt/nvm"
          \. "/opt/homebrew/opt/nvm/nvm.sh"
        # Try XDG config location
        elif [ -s "${XDG_CONFIG_HOME:-$HOME/.config}/nvm/nvm.sh" ]; then
          export NVM_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/nvm"
          \. "$NVM_DIR/nvm.sh"
        else
          print_error "Could not find nvm installation"
          print_warning "Tried locations: ~/.nvm, /opt/homebrew/opt/nvm, ~/.config/nvm"
          echo "Please source nvm manually or install it from: https://github.com/nvm-sh/nvm"
          exit 1
        fi
      fi

      # Check if version is already installed using nvm version for reliability
      if ! nvm version "$version" &> /dev/null; then
        print_warning "Node $version not installed. Installing..."
        if ! nvm install "$version"; then
          print_error "Failed to install Node $version with nvm"
          exit 1
        fi
      fi

      if ! nvm use "$version"; then
        print_error "Failed to switch to Node $version"
        print_warning "Make sure nvm is properly configured. Try running: nvm use $version"
        exit 1
      fi
      print_success "Switched to Node $version"
      ;;
    rvm)
      print_error "Cannot set Node version: rvm doesn't manage Node"
      echo "Please install one of the following to manage Node versions:"
      echo "  - nvm:  https://github.com/nvm-sh/nvm"
      echo "  - mise: https://mise.jdx.dev/ (recommended, manages both Ruby and Node)"
      echo "  - asdf: https://asdf-vm.com/ (manages both Ruby and Node)"
      exit 1
      ;;
  esac
}

show_status() {
  print_header "Current Configuration"
  echo ""

  echo "Runtime versions:"
  if command -v ruby &> /dev/null; then
    echo "  Ruby: $(ruby --version | awk '{print $2}')"
  else
    echo "  Ruby: not found"
  fi

  if command -v node &> /dev/null; then
    echo "  Node: $(node --version)"
  else
    echo "  Node: not found"
  fi

  echo ""
  echo "Dependency versions:"

  SHAKAPACKER_GEM=""
  if [ -f "$PROJECT_ROOT/Gemfile.development_dependencies" ]; then
    SHAKAPACKER_GEM=$(grep 'gem "shakapacker"' "$PROJECT_ROOT/Gemfile.development_dependencies" | sed -E 's/.*"([0-9.]+)".*/\1/' || echo "")
    echo "  Shakapacker (gem): ${SHAKAPACKER_GEM:-not found}"
  fi

  SHAKAPACKER_NPM=""
  if [ -f "$PROJECT_ROOT/spec/dummy/package.json" ]; then
    SHAKAPACKER_NPM=$(grep '"shakapacker"' "$PROJECT_ROOT/spec/dummy/package.json" | sed -E 's/.*"([0-9.]+)".*/\1/' || echo "")
    echo "  Shakapacker (npm): ${SHAKAPACKER_NPM:-not found}"
  fi

  REACT_ROOT=""
  if [ -f "$PROJECT_ROOT/package.json" ]; then
    REACT_ROOT=$(grep '"react":' "$PROJECT_ROOT/package.json" | head -1 | sed -E 's/.*"([^"]+)".*/\1/' || echo "")
    echo "  React (root): ${REACT_ROOT:-not found}"
  fi

  REACT_DUMMY=""
  if [ -f "$PROJECT_ROOT/spec/dummy/package.json" ]; then
    REACT_DUMMY=$(grep '"react":' "$PROJECT_ROOT/spec/dummy/package.json" | sed -E 's/.*"([^"]+)".*/\1/' || echo "")
    echo "  React (dummy): ${REACT_DUMMY:-not found}"
  fi

  echo ""
  if [[ "${SHAKAPACKER_GEM}" == "8.2.0" ]] && [[ "${REACT_ROOT}" == "18.0.0" ]]; then
    echo -e "Current config: ${GREEN}minimum${NC} (matches CI: Ruby 3.2, Node 20, minimum deps)"
  elif [[ "${SHAKAPACKER_GEM}" == "9.3.0" ]] && [[ "${REACT_ROOT}" =~ 19 ]]; then
    echo -e "Current config: ${GREEN}latest${NC} (matches CI: Ruby 3.4, Node 22, latest deps)"
  else
    echo -e "Current config: ${YELLOW}unknown/mixed${NC}"
  fi
}

switch_to_minimum() {
  local VERSION_MANAGER=$(check_version_manager)

  print_header "Switching to MINIMUM configuration"
  echo "  Target: Ruby 3.2, Node 20, Shakapacker 8.2.0, React 18.0.0"
  echo "  Using version manager: $VERSION_MANAGER"
  echo ""

  # Check if we have git changes
  if ! git diff --quiet || ! git diff --cached --quiet; then
    print_warning "You have uncommitted changes. This script will modify files."
    read -p "Continue? (y/N) " -n 1 -r REPLY
    echo
    if [[ ! "${REPLY}" =~ ^[Yy]$ ]]; then
      echo "Aborted."
      exit 1
    fi
  fi

  # Set Ruby and Node versions
  case "$VERSION_MANAGER" in
    mise|asdf)
      print_header "Setting runtime versions in .tool-versions"
      cat > "$PROJECT_ROOT/.tool-versions" <<EOF
ruby 3.2.8
nodejs 20.18.1
EOF
      print_success "Created .tool-versions with Ruby 3.2.8 and Node 20.18.1"
      ;;
    rvm|rvm+nvm)
      print_header "Creating .ruby-version for rvm"
      echo "3.2.8" > "$PROJECT_ROOT/.ruby-version"
      print_success "Created .ruby-version with Ruby 3.2.8"
      ;;
  esac

  case "$VERSION_MANAGER" in
    nvm|rvm+nvm)
      print_header "Creating .nvmrc for nvm"
      echo "20.18.1" > "$PROJECT_ROOT/.nvmrc"
      print_success "Created .nvmrc with Node 20.18.1"
      ;;
  esac

  set_ruby_version "3.2.8" "$VERSION_MANAGER"
  set_node_version "20.18.1" "$VERSION_MANAGER"

  # Run conversion script
  # NOTE: This uses whatever 'ruby' is in PATH after version manager updates above.
  # The version manager may not have reloaded yet, so ensure your current Ruby is
  # compatible with script/convert (Ruby 2.6+ should work).
  print_header "Running script/convert to downgrade dependencies"
  cd "$PROJECT_ROOT"
  ruby script/convert
  print_success "Dependency versions downgraded"

  # Clean and reinstall
  print_header "Cleaning node_modules and reinstalling"
  rm -rf node_modules
  if [ -f yarn.lock ]; then
    rm yarn.lock
  fi

  print_header "Installing root dependencies (without --frozen-lockfile)"
  yarn install --no-progress

  print_header "Cleaning spec/dummy and reinstalling"
  cd spec/dummy
  rm -rf node_modules vendor/bundle
  if [ -f yarn.lock ]; then
    rm yarn.lock
  fi

  yarn install --no-progress
  bundle install --path=vendor/bundle

  print_success "Dependencies installed"

  # Reload version manager to pick up new versions
  print_header "Reloading $VERSION_MANAGER to use new versions"
  case "$VERSION_MANAGER" in
    mise)
      # mise will auto-detect .tool-versions on next cd
      ;;
    asdf)
      # Note: This only affects the script's subshell, not the user's current shell
      if [ -f "$HOME/.asdf/asdf.sh" ]; then
        source "$HOME/.asdf/asdf.sh"
      fi
      ;;
    rvm|rvm+nvm)
      # Versions already set via rvm use
      ;;
    nvm)
      # Version already set via nvm use
      ;;
  esac

  echo ""
  print_success "Switched to MINIMUM configuration"

  case "$VERSION_MANAGER" in
    rvm+nvm|rvm|nvm)
      print_warning "IMPORTANT: Version changes in this script don't persist to your current shell."
      print_warning "The rvm/nvm commands run in a subshell and cannot affect your terminal."
      echo ""
      print_warning "Choose one of these options to activate the new versions:"
      echo "  Option 1 (Recommended): Open a new terminal and cd into the project"
      echo "  Option 2: Source your shell config:"
      [ "$VERSION_MANAGER" = "rvm" ] || [ "$VERSION_MANAGER" = "rvm+nvm" ] && echo "    source ~/.rvm/scripts/rvm"
      [ "$VERSION_MANAGER" = "nvm" ] || [ "$VERSION_MANAGER" = "rvm+nvm" ] && echo "    source \$NVM_DIR/nvm.sh"
      echo ""
      ;;
  esac

  print_warning "After activating versions, verify with:"
  echo "  cd $PROJECT_ROOT"
  case "$VERSION_MANAGER" in
    mise)
      echo "  mise current"
      ;;
    asdf)
      echo "  asdf current"
      ;;
    rvm+nvm)
      echo "  rvm current && nvm current"
      ;;
    rvm)
      echo "  rvm current"
      ;;
    nvm)
      echo "  nvm current"
      ;;
  esac
  echo ""
  print_warning "Next steps to build and test:"
  echo "  rake node_package"
  echo "  cd spec/dummy && bin/shakapacker-precompile-hook && RAILS_ENV=test bin/shakapacker"
  echo "  bundle exec rake run_rspec:all_dummy"
}

restore_to_latest() {
  local VERSION_MANAGER=$(check_version_manager)

  print_header "Restoring to LATEST configuration"
  echo "  Target: Ruby 3.4, Node 22, Shakapacker 9.3.0, React 19.0.0"
  echo "  Using version manager: $VERSION_MANAGER"
  echo ""

  # Check if we have git changes
  if ! git diff --quiet || ! git diff --cached --quiet; then
    print_warning "You have uncommitted changes. This script will restore from git."
    read -p "Continue? This will discard changes to package.json, Gemfile, etc. (y/N) " -n 1 -r REPLY
    echo
    if [[ ! "${REPLY}" =~ ^[Yy]$ ]]; then
      echo "Aborted."
      exit 1
    fi
  fi

  # Set Ruby and Node versions
  case "$VERSION_MANAGER" in
    mise|asdf)
      print_header "Setting runtime versions in .tool-versions"
      cat > "$PROJECT_ROOT/.tool-versions" <<EOF
ruby 3.4.3
nodejs 22.12.0
EOF
      print_success "Created .tool-versions with Ruby 3.4.3 and Node 22.12.0"
      ;;
    rvm|rvm+nvm)
      print_header "Creating .ruby-version for rvm"
      echo "3.4.3" > "$PROJECT_ROOT/.ruby-version"
      print_success "Created .ruby-version with Ruby 3.4.3"
      ;;
  esac

  case "$VERSION_MANAGER" in
    nvm|rvm+nvm)
      print_header "Creating .nvmrc for nvm"
      echo "22.12.0" > "$PROJECT_ROOT/.nvmrc"
      print_success "Created .nvmrc with Node 22.12.0"
      ;;
  esac

  set_ruby_version "3.4.3" "$VERSION_MANAGER"
  set_node_version "22.12.0" "$VERSION_MANAGER"

  # Restore files from git
  print_header "Restoring dependency files from git"
  cd "$PROJECT_ROOT"
  if ! git restore Gemfile.development_dependencies package.json spec/dummy/package.json packages/react-on-rails-pro/package.json 2>/dev/null; then
    print_warning "Some files could not be restored (may not exist in git)"
  else
    print_success "Files restored from git"
  fi

  # Clean and reinstall
  print_header "Cleaning node_modules and reinstalling"
  rm -rf node_modules
  if [ -f yarn.lock ]; then
    rm yarn.lock
  fi

  print_header "Installing root dependencies with --frozen-lockfile"
  yarn install --frozen-lockfile --no-progress

  print_header "Cleaning spec/dummy and reinstalling"
  cd spec/dummy
  rm -rf node_modules vendor/bundle
  if [ -f yarn.lock ]; then
    rm yarn.lock
  fi

  yarn install --frozen-lockfile --no-progress
  bundle install --path=vendor/bundle

  print_success "Dependencies installed"

  # Reload version manager to pick up new versions
  print_header "Reloading $VERSION_MANAGER to use new versions"
  case "$VERSION_MANAGER" in
    mise)
      # mise will auto-detect .tool-versions on next cd
      ;;
    asdf)
      # Note: This only affects the script's subshell, not the user's current shell
      if [ -f "$HOME/.asdf/asdf.sh" ]; then
        source "$HOME/.asdf/asdf.sh"
      fi
      ;;
    rvm|rvm+nvm)
      # Versions already set via rvm use
      ;;
    nvm)
      # Version already set via nvm use
      ;;
  esac

  echo ""
  print_success "Restored to LATEST configuration"

  case "$VERSION_MANAGER" in
    rvm+nvm|rvm|nvm)
      print_warning "IMPORTANT: Version changes in this script don't persist to your current shell."
      print_warning "The rvm/nvm commands run in a subshell and cannot affect your terminal."
      echo ""
      print_warning "Choose one of these options to activate the new versions:"
      echo "  Option 1 (Recommended): Open a new terminal and cd into the project"
      echo "  Option 2: Source your shell config:"
      [ "$VERSION_MANAGER" = "rvm" ] || [ "$VERSION_MANAGER" = "rvm+nvm" ] && echo "    source ~/.rvm/scripts/rvm"
      [ "$VERSION_MANAGER" = "nvm" ] || [ "$VERSION_MANAGER" = "rvm+nvm" ] && echo "    source \$NVM_DIR/nvm.sh"
      echo ""
      ;;
  esac

  print_warning "After activating versions, verify with:"
  echo "  cd $PROJECT_ROOT"
  case "$VERSION_MANAGER" in
    mise)
      echo "  mise current"
      ;;
    asdf)
      echo "  asdf current"
      ;;
    rvm+nvm)
      echo "  rvm current && nvm current"
      ;;
    rvm)
      echo "  rvm current"
      ;;
    nvm)
      echo "  nvm current"
      ;;
  esac
  echo ""
  print_warning "Next steps to build and test:"
  echo "  rake node_package"
  echo "  cd spec/dummy && bin/shakapacker-precompile-hook && RAILS_ENV=test bin/shakapacker"
  echo "  bundle exec rake run_rspec:all_dummy"
}

# Main script
case "${1:-}" in
  minimum)
    switch_to_minimum
    ;;
  latest)
    restore_to_latest
    ;;
  status)
    show_status
    ;;
  *)
    echo "Usage: $0 {minimum|latest|status}"
    echo ""
    echo "Commands:"
    echo "  minimum  - Switch to Ruby 3.2, Node 20, minimum dependencies (Shakapacker 8.2.0, React 18)"
    echo "  latest   - Switch to Ruby 3.4, Node 22, latest dependencies (Shakapacker 9.3.0, React 19)"
    echo "  status   - Show current configuration"
    echo ""
    echo "Examples:"
    echo "  $0 status           # Check current config"
    echo "  $0 minimum          # Switch to minimum deps for testing CI failures"
    echo "  $0 latest           # Switch back to latest deps"
    exit 1
    ;;
esac
