#!/usr/bin/env bash
# Format JS/TS/JSON/MD files with Prettier
set -euo pipefail

CONTEXT="${1:-staged}"
files="$(bin/lefthook/get-changed-files "$CONTEXT" '\.(js|jsx|ts|tsx|json|md|yml|yaml)$')"

if [ -z "$files" ]; then
  echo "âœ… No files to format with Prettier"
  exit 0
fi

# Separate files into root and Pro directories
root_files=$(echo "$files" | grep -v '^react_on_rails_pro/' || true)
pro_files=$(echo "$files" | grep '^react_on_rails_pro/' || true)

# Format root files
if [ -n "$root_files" ]; then
  if [ "$CONTEXT" = "all-changed" ]; then
    echo "ðŸ’… Prettier on root changed files:"
  else
    echo "ðŸ’… Prettier on root $CONTEXT files:"
  fi
  printf "  %s\n" $root_files

  pnpm run prettier --write $root_files
fi

# Format Pro files (using Pro's Prettier config)
if [ -n "$pro_files" ]; then
  if [ "$CONTEXT" = "all-changed" ]; then
    echo "ðŸ’… Prettier on Pro changed files:"
  else
    echo "ðŸ’… Prettier on Pro $CONTEXT files:"
  fi
  printf "  %s\n" $pro_files

  # Strip react_on_rails_pro/ prefix for running in Pro directory
  pro_files_relative=$(echo "$pro_files" | sed 's|^react_on_rails_pro/||')

  (cd react_on_rails_pro && pnpm run prettier --write $pro_files_relative)
fi

echo "âœ… Prettier formatting complete"
