#!/usr/bin/env bash
# Lint and auto-fix JS/TS files with ESLint
set -euo pipefail

CONTEXT="${1:-staged}"
files="$(bin/lefthook/get-changed-files "$CONTEXT" '\.(js|jsx|ts|tsx)$')"

if [ -z "$files" ]; then
  echo "‚úÖ No JS/TS files to lint with ESLint"
  exit 0
fi

# Separate files into root and Pro directories
root_files=$(echo "$files" | grep -v '^react_on_rails_pro/' || true)
pro_files=$(echo "$files" | grep '^react_on_rails_pro/' || true)

exit_code=0

# Lint root files
if [ -n "$root_files" ]; then
  if [ "$CONTEXT" = "all-changed" ]; then
    echo "üîç ESLint on root changed files:"
  else
    echo "üîç ESLint on root $CONTEXT files:"
  fi
  printf "  %s\n" $root_files

  if ! yarn run eslint $root_files --report-unused-disable-directives --fix; then
    exit_code=1
  fi

  # Re-stage files if running on staged or all-changed context
  if [ "$CONTEXT" = "staged" ] || [ "$CONTEXT" = "all-changed" ]; then
    echo $root_files | xargs -r git add
  fi
fi

# Lint Pro files (using Pro's ESLint config)
if [ -n "$pro_files" ]; then
  if [ "$CONTEXT" = "all-changed" ]; then
    echo "üîç ESLint on Pro changed files:"
  else
    echo "üîç ESLint on Pro $CONTEXT files:"
  fi
  printf "  %s\n" $pro_files

  # Strip react_on_rails_pro/ prefix for running in Pro directory
  pro_files_relative=$(echo "$pro_files" | sed 's|^react_on_rails_pro/||')

  if ! (cd react_on_rails_pro && yarn run eslint $pro_files_relative --report-unused-disable-directives --fix); then
    exit_code=1
  fi

  # Re-stage files if running on staged or all-changed context
  if [ "$CONTEXT" = "staged" ] || [ "$CONTEXT" = "all-changed" ]; then
    echo $pro_files | xargs -r git add
  fi
fi

if [ $exit_code -eq 0 ]; then
  echo "‚úÖ ESLint checks passed"
fi

exit $exit_code
