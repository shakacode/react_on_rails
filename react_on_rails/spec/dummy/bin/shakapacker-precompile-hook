#!/usr/bin/env ruby
# frozen_string_literal: true

# Self-guard: skip if bin/dev already ran precompile tasks.
# This prevents duplicate execution in HMR mode (two webpack processes)
# regardless of Shakapacker version.
exit 0 if ENV["SHAKAPACKER_SKIP_PRECOMPILE_HOOK"] == "true"

# Shakapacker precompile hook for React on Rails test dummy app
#
# This script loads the shared test helper implementation.
# For production apps, use the generator template which includes a standalone implementation.

# Find the gem root directory (three levels up from spec/dummy/bin)
gem_root = File.expand_path("../../..", __dir__)
shared_hook = File.join(gem_root, "spec", "support", "shakapacker_precompile_hook_shared.rb")

unless File.exist?(shared_hook)
  warn "Error: Shared precompile hook not found at #{shared_hook}"
  exit 1
end

# Load shared implementation (defines run_precompile_tasks)
load shared_hook

# Explicitly invoke run_precompile_tasks. The shared file's
# `if __FILE__ == $PROGRAM_NAME` block does not run when loaded via `load`.
run_precompile_tasks
