#!/usr/bin/env ruby
# frozen_string_literal: true

# Self-guard: skip if bin/dev already ran precompile tasks.
# This prevents duplicate execution in HMR mode (two webpack processes)
# regardless of Shakapacker version.
exit 0 if ENV["SHAKAPACKER_SKIP_PRECOMPILE_HOOK"] == "true"

# Shakapacker precompile hook for React on Rails Pro test dummy app
#
# This script loads the shared test helper implementation.
# For production apps, use the generator template which includes a standalone implementation.

# Find the repo root directory (four levels up from react_on_rails_pro/spec/dummy/bin)
repo_root = File.expand_path("../../../..", __dir__)
shared_hook = File.join(repo_root, "react_on_rails", "spec", "support", "shakapacker_precompile_hook_shared.rb")

unless File.exist?(shared_hook)
  warn "‚ùå Error: Shared precompile hook not found at #{shared_hook}"
  exit 1
end

# Load shared implementation (defines build_rescript_if_needed and generate_packs_if_needed)
load shared_hook

# Explicitly invoke the functions. The shared file's `if __FILE__ == $PROGRAM_NAME`
# block does not run when the file is loaded via `load`.
build_rescript_if_needed
generate_packs_if_needed
