<%#
  Large Props Stress Test Page

  This page tests JSON parsing with large props under various conditions:
  1. Large props (~200KB) with immediate hydration
  2. Delayed component registration to simulate async bundle loading
  3. Multiple components on the same page

  Used to reproduce: https://github.com/shakacode/react_on_rails/issues/2283
%>

<%= append_javascript_pack_tag 'large-props-bundle' %>

<script>
  // Configure the delay for component registration (simulates async bundle loading)
  window.__DELAYED_COMPONENT_REGISTRATION_DELAY__ = <%= @registration_delay %>;

  // Track any JSON parse errors
  window.__JSON_PARSE_ERRORS__ = [];

  // Monkey-patch JSON.parse to detect errors
  (function() {
    const originalParse = JSON.parse;
    JSON.parse = function(text, reviver) {
      try {
        return originalParse.call(this, text, reviver);
      } catch (e) {
        if (text && text.length > 10000) {
          const errorInfo = {
            error: e.message,
            textLength: text.length,
            firstChars: text.slice(0, 200),
            lastChars: text.slice(-200),
            timestamp: new Date().toISOString()
          };
          window.__JSON_PARSE_ERRORS__.push(errorInfo);
          console.error('[JSON Parse Error Detected]', errorInfo);
        }
        throw e;
      }
    };
  })();
</script>

<h1>Large Props Stress Test</h1>
<p>
  Testing JSON parsing with large props (~<%= (@large_props_first.to_json.length / 1024.0).round(2) %> KB per component)
</p>
<p>
  Registration delay: <%= @registration_delay %>ms
</p>

<div id="test-status" data-testid="test-status">
  <p>Components loading...</p>
</div>

<hr/>

<h2>Immediate Registration Component (LargePropsComponent)</h2>
<%= react_component("LargePropsComponent",
    props: @large_props_first,
    prerender: true,
    trace: true,
    auto_load_bundle: false,
    id: "LargePropsComponent-1") %>

<hr/>

<h2>Delayed Registration Component (DelayedLargePropsComponent)</h2>
<p><em>This component's bundle is registered after a <%= @registration_delay %>ms delay to simulate async loading.</em></p>
<%= react_component("DelayedLargePropsComponent",
    props: @large_props_second,
    prerender: true,
    trace: true,
    auto_load_bundle: false,
    id: "DelayedLargePropsComponent-1") %>

<hr/>

<h2>Multiple Large Props Components</h2>
<p><em>Testing concurrent rendering of multiple large-prop components.</em></p>

<% 3.times do |i| %>
  <%= react_component("LargePropsComponent",
      props: @large_props_array[i],
      prerender: true,
      trace: true,
      auto_load_bundle: false,
      id: "LargePropsComponent-multi-#{i}") %>
<% end %>

<hr/>

<h2>Test Information</h2>
<pre id="test-info">
Total props size: <%= (@total_props_size / 1024.0).round(2) %> KB
Components: 5 (1 immediate, 1 delayed, 3 multi)
Registration delay: <%= @registration_delay %>ms
Timestamp: <%= Time.now.iso8601 %>
</pre>

<script>
  // Update status when all components are rendered
  document.addEventListener('DOMContentLoaded', function() {
    const checkInterval = setInterval(function() {
      const components = document.querySelectorAll('[data-testid^="large-props-component-"], [data-testid^="delayed-large-props-component-"]');
      const statusElements = document.querySelectorAll('[data-testid="status"], [data-testid="delayed-status"]');

      if (statusElements.length >= 5) {
        clearInterval(checkInterval);
        const statusDiv = document.getElementById('test-status');
        if (window.__JSON_PARSE_ERRORS__.length > 0) {
          statusDiv.innerHTML = '<p style="color: red;">FAILED: JSON parse errors detected! See console.</p>';
          statusDiv.dataset.status = 'failed';
        } else {
          statusDiv.innerHTML = '<p style="color: green;">SUCCESS: All components rendered without JSON errors.</p>';
          statusDiv.dataset.status = 'success';
        }
      }
    }, 100);

    // Timeout after 10 seconds
    setTimeout(function() {
      clearInterval(checkInterval);
      const statusDiv = document.getElementById('test-status');
      if (!statusDiv.dataset.status) {
        statusDiv.innerHTML = '<p style="color: orange;">TIMEOUT: Not all components rendered within 10 seconds.</p>';
        statusDiv.dataset.status = 'timeout';
      }
    }, 10000);
  });
</script>
