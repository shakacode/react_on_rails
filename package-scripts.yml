scripts:
  test:
    default:
      description: Run all JS tests
      script: jest packages/node-renderer
    ci:
      description: Run all JS tests in CI mode
      # https://circleci.com/docs/collect-test-data/#jest
      script: jest --ci --runInBand --reporters=default --reporters=jest-junit -- packages/node-renderer
    debug:
      description: Debug all JS tests
      script: ndb jest --runInBand packages/node-renderer
  check:
    description: Run all checks
    script: nps lint && nps format.listDifferent && nps test && nps check-typescript
  check-typescript:
    description: Check for TypeScript errors
    script: nps "build --noEmit" && tsc --project packages/node-renderer/tests && cd spec/dummy && yarn run tsc -p client/tsconfig.json --noEmit
  fix:
    description: Run all code fixes before committing
    script: nps eslint.fix && nps format
  node-renderer:
    default:
      description:
      script: nps build && node --enable-source-maps packages/node-renderer/dist/default-node-renderer.js
    debug:
      description: Debug Node Renderer
      script: rm -rf /tmp/react-on-rails-pro-node-renderer-bundles && nps build && RENDERER_LOG_LEVEL=info NODE_DEBUG=ROR node --enable-source-maps packages/node-renderer/dist/default-node-renderer.js
  lint:
    description: Run all linters
    script: concurrently --prefix "[{name}]" --names "ESLINT, RUBOCOP, PRETTIER" -c "blue,yellow,magenta,orange" "nps eslint" "bundle exec rubocop" "nps format.listDifferent"

  build:
    default:
      description: Build the project
      script: echo "building the project" && rm -rf packages/node-renderer/dist && tsc --project packages/node-renderer/src
    prepack:
      description: Build the project in the prepack/prepare scripts
      # This is necessary when used as a Git dependency since we don't have the dist directory in the repo.
      # Depending on the package manager, `prepack`, `prepare`, or both may be run.
      # They may also be run when publishing or in other cases, so we want to cover all of them.
      # 1. If the project is already built, do nothing;
      # 2. Build the project but ignore TypeScript errors from missing devDependencies;
      # 3. Check if the project is built now;
      # 4. If it failed, print an error message (still follow https://docs.npmjs.com/cli/v8/using-npm/scripts#best-practices).
      script: >
        [ -f packages/node-renderer/dist/ReactOnRailsProNodeRenderer.js ] ||
          (nps build >/dev/null 2>&1 || true) &&
          [ -f packages/node-renderer/dist/ReactOnRailsProNodeRenderer.js ] ||
          { echo 'Building @shakacode-tools/react-on-rails-pro-node-renderer seems to have failed!'; }

  clean:
    description: Clean the project
    script: rm -rf packages/node-renderer/dist

  eslint:
    default:
      description: Run eslint.
      script: eslint . --ext ".js,.mts,.mjs,.jsx,.ts,.tsx" --report-unused-disable-directives
    fix:
      description: Run eslint and auto-fix.
      script: nps "eslint --fix"
    debug:
      description: Run eslint in debug mode.
      script: DEBUG=eslint:cli-engine nps eslint

  format:
    default:
      description: Format files using prettier.
      script: concurrently --prefix "[{name}]" --names "js,ts,json" -c "yellow,magenta,green" "nps format.js" "nps format.ts" "nps format.json"
    listDifferent:
      description: Check that all files were formatted using prettier.
      script: |
        concurrently \
          --prefix "[{name}]" \
          --names "js,ts,json" \
          -c "yellow,magenta,green" \
          "nps format.js.listDifferent" \
          "nps format.ts.listDifferent" \
          "nps format.json.listDifferent"
    js:
      default:
        description: Run prettier on JS.
        script: prettier "**/*.@(js|jsx|mjs)" --write
      listDifferent:
        description: Check if any JS files would change by running prettier.
        script: prettier "**/*.@(js|jsx|mjs)" --list-different
    ts:
      default:
        description: Run prettier on TS.
        script: prettier "**/*.@(ts|tsx)" --write
      listDifferent:
        description: Check if any TS files would change by running prettier.
        script: prettier "**/*.@(ts|tsx)" --list-different
    json:
      default:
        description: Run prettier on JSON files.
        script: rm -rf packages/node-renderer/tests/tmp && prettier "**/*.json" --write
      listDifferent:
        description: Check if any JSON files would change by running prettier.
        script: prettier "**/*.json" --list-different

  renderer:
    default:
      description: Starts the node renderer.
      script: nps build && RENDERER_PORT=3800 RENDERER_SUPPORT_MODULES=TRUE node ./packages/node-renderer/dist/default-node-renderer.js
    debug:
      description: Starts the node renderer with debugging enabled. See Node.js V8 --inspector Manager (NiM)
      script: nps build && RENDERER_WORKERS_COUNT=1 RENDERER_PORT=3800 RENDERER_SUPPORT_MODULES=TRUE ndb ./packages/node-renderer/dist/default-node-renderer.js
