#!/usr/bin/env ruby
# frozen_string_literal: true

# This script converts the codebase to use minimum supported dependency versions.
# It's run during CI when testing the "minimum" dependency matrix to ensure
# backward compatibility.
#
# React/Shakapacker version compatibility is now tested through generator smoke tests
# (see examples_config.yml for minimum version examples like basic-minimum).
# This script only handles Node.js/tooling compatibility and Pro package test adjustments.

def gsub_file_content(path, old_content, new_content)
  path = File.expand_path(path, __dir__)

  # Support both old structure (files at root) and new structure (files in react_on_rails/)
  # This allows the script to work before and after the monorepo reorganization
  unless File.exist?(path)
    # Try alternate locations:
    # 1. For react_on_rails subdirectory paths, try removing that nesting
    # 2. For packages/* paths, try the old node_package/ location
    alternate_paths = [
      path.sub(%r{/react_on_rails/}, "/"),
      path.sub(%r{/packages/react-on-rails/}, "/node_package/"),
      path.sub(%r{/packages/react-on-rails-pro/}, "/react_on_rails_pro/node_package/")
    ]

    alternate_paths.each do |alt_path|
      if File.exist?(alt_path)
        path = alt_path
        break
      end
    end
  end

  unless File.exist?(path)
    warn "Warning: File not found: #{path}"
    return
  end

  content = File.binread(path)
  content.gsub!(old_content, new_content)
  File.binwrite(path, content)
end

# The below packages don't work on the oldest supported Node version and aren't needed there anyway
# Note: All dev dependencies remain in root package.json even after workspace migration
gsub_file_content("../package.json", /"[^"]*eslint[^"]*": "[^"]*",?/, "")
gsub_file_content("../package.json", /"globals": "[^"]*",/, "")
gsub_file_content("../package.json", /"knip": "[^"]*",/, "")
gsub_file_content("../package.json", /"publint": "[^"]*",/, "")
gsub_file_content("../package.json", %r{"@arethetypeswrong/cli": "[^"]*",}, "")
gsub_file_content("../package.json", %r{"@testing-library/[^"]*": "[^"]*",}, "")

# Clean up any trailing commas before closing braces
gsub_file_content("../package.json", /,(\s*})/, "\\1")

# Switch to minimum supported React version (React 18 since we removed PropTypes)
gsub_file_content("../package.json", /"react": "[^"]*",/, '"react": "18.0.0",')
gsub_file_content("../package.json", /"react-dom": "[^"]*",/, '"react-dom": "18.0.0",')
gsub_file_content("../packages/react-on-rails-pro/package.json", /"react": "[^"]*",/, '"react": "18.0.0",')
gsub_file_content("../packages/react-on-rails-pro/package.json", /"react-dom": "[^"]*",/, '"react-dom": "18.0.0",')
gsub_file_content("../react_on_rails/spec/dummy/package.json", /"react": "[^"]*",/, '"react": "18.0.0",')
gsub_file_content("../react_on_rails/spec/dummy/package.json", /"react-dom": "[^"]*",/, '"react-dom": "18.0.0",')

# Switch from @dr.pogodin/react-helmet (React 19+) to react-helmet-async (React 18 compatible)
# Both have the same HelmetProvider API, but different package names
gsub_file_content("../react_on_rails/spec/dummy/package.json", /"@dr\.pogodin\/react-helmet": "[^"]*",/, '"react-helmet-async": "^1.3.0",')
# Update import statements in all client files
Dir.glob(File.expand_path("../react_on_rails/spec/dummy/client/**/*.{js,jsx,ts,tsx}", __dir__)).each do |file|
  content = File.binread(file)
  if content.include?("@dr.pogodin/react-helmet")
    content.gsub!(%r{from ['"]@dr\.pogodin/react-helmet['"]}, 'from "react-helmet-async"')
    content.gsub!(%r{['"]@dr\.pogodin/react-helmet['"]}, '"react-helmet-async"')
    File.binwrite(file, content)
  end
end

# Pro package: Skip RSC tests on React 18 since RSC requires React 19
gsub_file_content(
  "../packages/react-on-rails-pro/package.json",
  /"test:non-rsc": "(?:\\"|[^"])*",/,
  '"test:non-rsc": "jest tests --testPathIgnorePatterns=\".*(RSC|stream|' \
  'registerServerComponent|serverRenderReactComponent|SuspenseHydration).*\"",'
)
# test:rsc script now automatically detects React version and skips on React 18
# No override needed - the script checks React version and exits cleanly if < 19
