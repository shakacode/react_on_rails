name: Detect Changes

on:
  workflow_call:
    outputs:
      docs_only:
        description: 'Only documentation files changed'
        value: ${{ jobs.detect.outputs.docs_only }}
      run_lint:
        description: 'Should run linting'
        value: ${{ jobs.detect.outputs.run_lint }}
      run_ruby_tests:
        description: 'Should run Ruby tests'
        value: ${{ jobs.detect.outputs.run_ruby_tests }}
      run_js_tests:
        description: 'Should run JS tests'
        value: ${{ jobs.detect.outputs.run_js_tests }}
      run_dummy_tests:
        description: 'Should run dummy app tests'
        value: ${{ jobs.detect.outputs.run_dummy_tests }}
      run_generators:
        description: 'Should run generator tests'
        value: ${{ jobs.detect.outputs.run_generators }}

jobs:
  detect:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      actions: read
    outputs:
      docs_only: ${{ steps.changes.outputs.docs_only }}
      run_lint: ${{ steps.changes.outputs.run_lint }}
      run_ruby_tests: ${{ steps.changes.outputs.run_ruby_tests }}
      run_js_tests: ${{ steps.changes.outputs.run_js_tests }}
      run_dummy_tests: ${{ steps.changes.outputs.run_dummy_tests }}
      run_generators: ${{ steps.changes.outputs.run_generators }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Detect changes
        id: changes
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha || github.event.before || 'origin/master' }}"
          script/ci-changes-detector "$BASE_SHA"
      - name: Guard docs-only master pushes
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: ./.github/actions/ensure-master-docs-safety
        with:
          docs-only: ${{ steps.changes.outputs.docs_only }}
          previous-sha: ${{ github.event.before }}
