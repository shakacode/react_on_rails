name: Benchmark Workflow

on:
  # https://github.com/mxschmitt/action-tmate?tab=readme-ov-file#manually-triggered-debug
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable SSH access (‚ö†Ô∏è Security Risk - read workflow comments)'
        required: false
        default: false
        type: boolean
      routes:
        description: 'Comma-separated routes to benchmark (e.g., "/,/hello"). Leave empty to auto-detect from Rails.'
        required: false
        type: string
      rate:
        description: 'Requests per second (use "max" for maximum throughput)'
        required: false
        default: 'max'
        type: string
      duration:
        description: 'Duration (e.g., "30s", "1m", "90s")'
        required: false
        default: '30s'
        type: string
      request_timeout:
        description: 'Request timeout (e.g., "60s", "1m", "90s")'
        required: false
        default: '60s'
        type: string
      connections:
        description: 'Concurrent connections/virtual users (also used as max)'
        required: false
        default: 10
        type: number
      web_concurrency:
        description: 'Number of Puma worker processes'
        required: false
        default: 4
        type: number
      rails_threads:
        description: 'Number of Puma threads (min and max will be same)'
        required: false
        default: 3
        type: number
      tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'fortio,vegeta,k6'
        type: string
      app_version:
        description: 'Which app version to benchmark'
        required: false
        default: 'both'
        type: choice
        options:
          - 'both'
          - 'core_only'
          - 'pro_only'
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    paths-ignore:
      - '**.md'
      - 'docs/**'
env:
  RUBY_VERSION: "3.3.7"
  BUNDLER_VERSION: "2.5.4"
  FORTIO_VERSION: "1.73.0"
  K6_VERSION: "1.4.2"
  VEGETA_VERSION: "12.13.0"
  # Determine which apps to run (default is 'pro_only' for all triggers)
  RUN_CORE: ${{ (github.event.inputs.app_version || 'both') != 'pro_only' && 'true' || '' }}
  RUN_PRO: ${{ (github.event.inputs.app_version || 'both') != 'core_only' && 'true' || '' }}
  # Benchmark parameters (defaults in bench.rb unless overridden here for CI)
  ROUTES: ${{ github.event.inputs.routes }}
  RATE: ${{ github.event.inputs.rate || 'max' }}
  DURATION: ${{ github.event.inputs.duration }}
  REQUEST_TIMEOUT: ${{ github.event.inputs.request_timeout }}
  CONNECTIONS: ${{ github.event.inputs.connections }}
  MAX_CONNECTIONS: ${{ github.event.inputs.connections }}
  WEB_CONCURRENCY: ${{ github.event.inputs.web_concurrency || 4 }}
  RAILS_MAX_THREADS: ${{ github.event.inputs.rails_threads || 3 }}
  RAILS_MIN_THREADS: ${{ github.event.inputs.rails_threads || 3 }}
  TOOLS: ${{ github.event.inputs.tools || 'fortio,vegeta,k6' }}

jobs:
  benchmark:
    # Run on: push to master, workflow_dispatch, or PRs with 'full-ci' or 'benchmark' labels
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'full-ci') ||
      contains(github.event.pull_request.labels.*.name, 'benchmark')
    runs-on: ubuntu-latest
    env:
      SECRET_KEY_BASE: 'dummy-secret-key-for-ci-testing-not-used-in-production'
      REACT_ON_RAILS_PRO_LICENSE: ${{ secrets.REACT_ON_RAILS_PRO_LICENSE_V2 }}

    steps:
      # ============================================
      # STEP 1: CHECKOUT CODE
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ============================================
      # STEP 2: OPTIONAL SSH ACCESS
      # ============================================
      # NOTE: Interactive confirmation is not possible in GitHub Actions.
      # As a secure workaround, SSH access is gated by the workflow_dispatch
      # input variable 'debug_enabled' which defaults to false.
      # Users must explicitly set this to true to enable SSH.

      - name: SSH Warning
        if: ${{ github.event.inputs.debug_enabled == true || github.event.inputs.debug_enabled == 'true' }}
        run: |
          echo "‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  SSH ACCESS ENABLED  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è"
          echo ""
          echo "SECURITY NOTICE:"
          echo "  - SSH access exposes your GitHub Actions runner"
          echo "  - Only proceed if you understand and accept the risks"
          echo "  - Do NOT store secrets or sensitive data on the runner"
          echo "  - Access is limited to the workflow initiator only"
          echo "  - The session will remain open until manually terminated"
          echo ""
          echo "‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è"

      - name: Setup SSH access (if enabled)
        if: ${{ github.event.inputs.debug_enabled == true || github.event.inputs.debug_enabled == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          limit-access-to-actor: true  # Only workflow trigger can access

      # ============================================
      # STEP 3: INSTALL BENCHMARKING TOOLS
      # ============================================

      - name: Add tools directory to PATH
        run: |
          mkdir -p ~/bin
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Cache Fortio binary
        id: cache-fortio
        if: contains(env.TOOLS, 'fortio')
        uses: actions/cache@v4
        with:
          path: ~/bin/fortio
          key: fortio-${{ runner.os }}-${{ runner.arch }}-${{ env.FORTIO_VERSION }}

      - name: Install Fortio
        if: contains(env.TOOLS, 'fortio') && steps.cache-fortio.outputs.cache-hit != 'true'
        run: |
          echo "üì¶ Installing Fortio v${FORTIO_VERSION}"
          
          # Download and extract fortio binary
          wget -q https://github.com/fortio/fortio/releases/download/v${FORTIO_VERSION}/fortio-linux_amd64-${FORTIO_VERSION}.tgz
          tar -xzf fortio-linux_amd64-${FORTIO_VERSION}.tgz

          # Store in cache directory
          mv usr/bin/fortio ~/bin/

      - name: Cache Vegeta binary
        id: cache-vegeta
        if: contains(env.TOOLS, 'vegeta')
        uses: actions/cache@v4
        with:
          path: ~/bin/vegeta
          key: vegeta-${{ runner.os }}-${{ runner.arch }}-${{ env.VEGETA_VERSION }}

      - name: Install Vegeta
        if: contains(env.TOOLS, 'vegeta') && steps.cache-vegeta.outputs.cache-hit != 'true'
        run: |
          echo "üì¶ Installing Vegeta v${VEGETA_VERSION}"

          # Download and extract vegeta binary
          wget -q https://github.com/tsenart/vegeta/releases/download/v${VEGETA_VERSION}/vegeta_${VEGETA_VERSION}_linux_amd64.tar.gz
          tar -xzf vegeta_${VEGETA_VERSION}_linux_amd64.tar.gz

          # Store in cache directory
          mv vegeta ~/bin/

      - name: Setup k6
        if: contains(env.TOOLS, 'k6')
        uses: grafana/setup-k6-action@v1
        with:
          k6-version: ${{ env.K6_VERSION }}

      # ============================================
      # STEP 4: START APPLICATION SERVER
      # ============================================

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler: ${{ env.BUNDLER_VERSION }}

      - name: Get gem home directory
        run: echo "GEM_HOME_PATH=$(gem env home)" >> $GITHUB_ENV

      - name: Cache foreman gem
        id: cache-foreman
        uses: actions/cache@v4
        with:
          path: ${{ env.GEM_HOME_PATH }}
          key: foreman-gem-${{ runner.os }}-ruby-${{ env.RUBY_VERSION }}

      - name: Install foreman
        if: steps.cache-foreman.outputs.cache-hit != 'true'
        run: gem install foreman

      - name: Fix dependency for libyaml-dev
        run: sudo apt install libyaml-dev -y

      # Follow https://github.com/pnpm/action-setup?tab=readme-ov-file#use-cache-to-reduce-installation-time
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          cache: true
          cache_dependency_path: '**/pnpm-lock.yaml'
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Print system information
        run: |
          echo "Linux release: "; cat /etc/issue
          echo "Current user: "; whoami
          echo "Current directory: "; pwd
          echo "Ruby version: "; ruby -v
          echo "Node version: "; node -v
          echo "Pnpm version: "; pnpm --version
          echo "Bundler version: "; bundle --version

      - name: Install Node modules with Pnpm for all packages
        run: |
          pnpm install --recursive --frozen-lockfile
          pnpm add --global yalc

      - name: yalc publish for react-on-rails
        run: cd packages/react-on-rails && yalc publish

      # TODO only needed while we use --ignore-workspace below
      - name: Cache core dummy app node modules
        if: env.RUN_CORE
        uses: actions/cache@v4
        with:
          path: react_on_rails/spec/dummy/node_modules
          key: v4-pro-dummy-app-node-modules-cache-${{ hashFiles('pnpm-lock.yaml', 'react_on_rails/spec/dummy/package.json') }}

      - name: Install Node modules for the dummy app
        if: env.RUN_CORE
        # TODO simplify this both here and in integration tests
        # --ignore-workspace prevents pnpm from treating this as part of the parent workspace
        # The dummy app doesn't have a pnpm-lock.yaml and shouldn't use frozen lockfile
        run: |
          cd react_on_rails/spec/dummy
          yalc add react-on-rails
          pnpm install --ignore-workspace

      - name: Save Core dummy app ruby gems to cache
        if: env.RUN_CORE
        uses: actions/cache@v4
        with:
          path: react_on_rails/spec/dummy/vendor/bundle
          key: v4-core-dummy-app-gem-cache-${{ hashFiles('react_on_rails/spec/dummy/Gemfile.lock') }}

      - name: Install Ruby Gems for Core dummy app
        if: env.RUN_CORE
        run: |
          cd react_on_rails/spec/dummy
          bundle config set path vendor/bundle
          bundle config set frozen true
          bundle _${BUNDLER_VERSION}_ install --jobs=4 --retry=3

      - name: Prepare Core production assets
        if: env.RUN_CORE
        run: |
          set -e  # Exit on any error
          echo "üî® Building production assets..."
          cd react_on_rails/spec/dummy

          if ! bin/prod-assets; then
            echo "‚ùå ERROR: Failed to build production assets"
            exit 1
          fi

          echo "‚úÖ Production assets built successfully"

      - name: Start Core production server
        if: env.RUN_CORE
        run: |
          set -e  # Exit on any error
          echo "üöÄ Starting production server..."
          cd react_on_rails/spec/dummy

          # Start server in background (Core uses rails directly, not foreman)
          bin/prod &
          echo "Server started in background"

          # Wait for server to be ready (max 30 seconds)
          echo "‚è≥ Waiting for server to be ready..."
          for i in {1..30}; do
            if curl -fsS http://localhost:3001 > /dev/null; then
              echo "‚úÖ Server is ready and responding"
              exit 0
            fi
            echo "  Attempt $i/30: Server not ready yet..."
            sleep 1
          done

          echo "‚ùå ERROR: Server failed to start within 30 seconds"
          exit 1

      # ============================================
      # STEP 5: RUN CORE BENCHMARKS
      # ============================================

      - name: Execute Core benchmark suite
        if: env.RUN_CORE
        timeout-minutes: 120
        run: |
          set -e  # Exit on any error
          echo "üèÉ Running Core benchmark suite..."

          if ! ruby benchmarks/bench.rb; then
            echo "‚ùå ERROR: Benchmark execution failed"
            exit 1
          fi

          echo "‚úÖ Benchmark suite completed successfully"

      - name: Validate Core benchmark results
        if: env.RUN_CORE
        run: |
          set -e
          echo "üîç Validating benchmark results..."

          if [ ! -f "bench_results/summary.txt" ]; then
            echo "‚ùå ERROR: benchmark summary file not found"
            exit 1
          fi

          echo "‚úÖ Benchmark results found"
          echo ""
          echo "üìä Summary:"
          column -t -s $'\t' bench_results/summary.txt
          echo ""
          echo "Generated files:"
          ls -lh bench_results/

      - name: Upload Core benchmark results
        uses: actions/upload-artifact@v4
        if: env.RUN_CORE && always()
        with:
          name: benchmark-core-results-${{ github.run_number }}
          path: bench_results/
          retention-days: 30
          if-no-files-found: warn

      - name: Stop Core production server
        if: env.RUN_CORE && always()
        run: |
          echo "üõë Stopping Core production server..."
          # Kill all server-related processes (safe in isolated CI environment)
          pkill -9 -f "ruby|node|foreman|overmind|puma" || true

          # Wait for port 3001 to be free
          echo "‚è≥ Waiting for port 3001 to be free..."
          for _ in {1..10}; do
            if ! lsof -ti:3001 > /dev/null 2>&1; then
              echo "‚úÖ Port 3001 is now free"
              exit 0
            fi
            sleep 1
          done

          echo "‚ùå ERROR: Port 3001 is still in use after 10 seconds"
          echo "Processes using port 3001:"
          lsof -i:3001 || true
          exit 1

      # ============================================
      # STEP 6: SETUP PRO APPLICATION SERVER
      # ============================================
      - name: Cache Pro dummy app node modules
        if: env.RUN_PRO
        uses: actions/cache@v4
        with:
          path: react_on_rails_pro/spec/dummy/node_modules
          key: v4-pro-dummy-app-node-modules-cache-${{ hashFiles('pnpm-lock.yaml', 'react_on_rails_pro/spec/dummy/package.json') }}

      - name: yalc publish for react-on-rails-pro
        if: env.RUN_PRO
        run: cd packages/react-on-rails-pro && yalc publish

      # Same reason for --ignore-workspace as for core
      # TODO Remove it here as well
      - name: Install Node modules with Pnpm for Pro dummy app
        if: env.RUN_PRO
        run: |
          cd react_on_rails_pro/spec/dummy
          yalc add react-on-rails-pro
          pnpm install --ignore-workspace

      - name: Cache Pro dummy app Ruby gems
        if: env.RUN_PRO
        uses: actions/cache@v4
        with:
          path: react_on_rails_pro/spec/dummy/vendor/bundle
          key: v4-pro-dummy-app-gem-cache-${{ hashFiles('react_on_rails_pro/spec/dummy/Gemfile.lock') }}

      - name: Install Ruby Gems for Pro dummy app
        if: env.RUN_PRO
        run: |
          cd react_on_rails_pro/spec/dummy
          bundle config set path vendor/bundle
          bundle config set frozen true
          bundle _${BUNDLER_VERSION}_ install --jobs=4 --retry=3

      - name: Generate file-system based entrypoints for Pro
        if: env.RUN_PRO
        run: cd react_on_rails_pro/spec/dummy && bundle exec rake react_on_rails:generate_packs

      - name: Prepare Pro production assets
        if: env.RUN_PRO
        run: |
          set -e
          echo "üî® Building Pro production assets..."
          cd react_on_rails_pro/spec/dummy

          if ! bin/prod-assets; then
            echo "‚ùå ERROR: Failed to build production assets"
            exit 1
          fi

          echo "‚úÖ Production assets built successfully"

      - name: Start Pro production server
        if: env.RUN_PRO
        run: |
          set -e
          echo "üöÄ Starting Pro production server..."
          cd react_on_rails_pro/spec/dummy

          # Start server in background
          bin/prod &
          echo "Server started in background"

          # Wait for server to be ready (max 30 seconds)
          echo "‚è≥ Waiting for server to be ready..."
          for i in {1..30}; do
            if curl -fsS http://localhost:3001 > /dev/null; then
              echo "‚úÖ Server is ready and responding"
              exit 0
            fi
            echo "  Attempt $i/30: Server not ready yet..."
            sleep 1
          done

          echo "‚ùå ERROR: Server failed to start within 30 seconds"
          exit 1

      # ============================================
      # STEP 7: RUN PRO BENCHMARKS
      # ============================================

      - name: Execute Pro benchmark suite
        if: env.RUN_PRO
        timeout-minutes: 120
        run: |
          set -e
          echo "üèÉ Running Pro benchmark suite..."

          if ! PRO=true ruby benchmarks/bench.rb; then
            echo "‚ùå ERROR: Benchmark execution failed"
            exit 1
          fi

          echo "‚úÖ Benchmark suite completed successfully"

      - name: Validate Pro benchmark results
        if: env.RUN_PRO
        run: |
          set -e
          echo "üîç Validating benchmark results..."

          if [ ! -f "bench_results/summary.txt" ]; then
            echo "‚ùå ERROR: benchmark summary file not found"
            exit 1
          fi

          echo "‚úÖ Benchmark results found"
          echo ""
          echo "üìä Summary:"
          column -t -s $'\t' bench_results/summary.txt
          echo ""
          echo "Generated files:"
          ls -lh bench_results/

      - name: Upload Pro benchmark results
        uses: actions/upload-artifact@v4
        if: env.RUN_PRO && always()
        with:
          name: benchmark-pro-results-${{ github.run_number }}
          path: bench_results/
          retention-days: 30
          if-no-files-found: warn

      - name: Stop Pro production server
        if: env.RUN_PRO && always()
        run: |
          echo "üõë Stopping Pro production server..."
          # Kill all server-related processes (safe in isolated CI environment)
          pkill -9 -f "ruby|node|foreman|overmind|puma" || true
          echo "‚úÖ Server stopped"

      # ============================================
      # STEP 8: WORKFLOW COMPLETION
      # ============================================
      - name: Workflow summary
        if: always()
        run: |
          echo "üìã Benchmark Workflow Summary"
          echo "===================================="
          echo "Status: ${{ job.status }}"
          echo "Run number: ${{ github.run_number }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Run Core: ${{ env.RUN_CORE }}"
          echo "Run Pro: ${{ env.RUN_PRO }}"
          echo ""
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ All steps completed successfully"
          else
            echo "‚ùå Workflow encountered errors - check logs above"
          fi
