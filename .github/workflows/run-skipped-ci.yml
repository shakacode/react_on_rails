name: Run Full CI Suite

on:
  issue_comment:
    types: [created]

# Prevent concurrent runs per PR
concurrency:
  group: full-ci-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  trigger-full-ci:
    # Only run on PR comments that match the command
    if: |
      github.event.issue.pull_request &&
      (
        startsWith(github.event.comment.body, '/run-skipped-ci') ||
        contains(github.event.comment.body, '\n/run-skipped-ci')
      )
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      pull-requests: write
      actions: write
    steps:
      - name: Check if user has write access
        id: check_access
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.actor
              });

              const hasAccess = ['admin', 'write'].includes(permission.permission);
              console.log(`User ${context.actor} has permission: ${permission.permission}`);

              if (!hasAccess) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `@${context.actor} Sorry, only repository collaborators with write access can trigger full CI runs. ðŸ”’`
                });
              }

              return hasAccess;
            } catch (error) {
              console.error('Error checking permissions:', error);
              return false;
            }

      - name: Exit if no access
        if: steps.check_access.outputs.result == 'false'
        run: |
          echo "User does not have permission to trigger full CI"
          exit 1

      - name: Add reaction to comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: 'rocket'

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              ref: pr.data.head.ref,
              sha: pr.data.head.sha
            };

      - name: Post acknowledgment comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ðŸš€ **Running full CI suite** on commit `${{ fromJSON(steps.pr.outputs.result).sha }}`

            This will run all CI jobs including those normally skipped on PRs:
            - âœ… Minimum dependency versions (Ruby 3.2, Node 20)
            - âœ… All example app tests
            - âœ… Pro package integration tests
            - âœ… Pro package unit tests

            View progress in the [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions).

      - name: Trigger all workflows and collect results
        id: trigger_workflows
        uses: actions/github-script@v7
        with:
          script: |
            const prData = ${{ steps.pr.outputs.result }};
            const workflows = [
              'main.yml',
              'examples.yml',
              'pro-integration-tests.yml',
              'pro-package-tests.yml'
            ];

            const succeeded = [];
            const failed = [];

            for (const workflowId of workflows) {
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflowId,
                  ref: prData.ref
                });
                console.log(`âœ… Triggered ${workflowId}`);
                succeeded.push(workflowId);
              } catch (error) {
                console.error(`âŒ Failed to trigger ${workflowId}:`, error.message);
                failed.push(workflowId);
              }
            }

            // Build the comment body
            const status = failed.length === 0 ? 'âœ… **Successfully triggered all workflows**' : 'âš ï¸ **Some workflows failed to trigger**';
            const succeededList = succeeded.length > 0 ? succeeded.map(w => `- âœ… ${w}`).join('\n') : '- None';
            const failedList = failed.length > 0 ? `\n\n**Failed workflows:**\n${failed.map(w => `- âŒ ${w}`).join('\n')}` : '';

            const body = `${status}

            **Triggered workflows:**
            ${succeededList}${failedList}

            View progress in the [Actions tab](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions).`;

            // Post the comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

            // Fail the job if any workflows failed to trigger
            if (failed.length > 0) {
              core.setFailed(`Failed to trigger ${failed.length} workflow(s): ${failed.join(', ')}`);
            }
