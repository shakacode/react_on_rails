#!/usr/bin/env ruby
# frozen_string_literal: true

# Shakapacker precompile hook for React on Rails
#
# This script runs before webpack compilation to generate pack files
# for auto-bundled components.
#
# It's called automatically by Shakapacker when configured in config/shakapacker.yml:
#   precompile_hook: 'bin/shakapacker-precompile-hook'
#
# See: https://github.com/shakacode/shakapacker/blob/main/docs/precompile_hook.md

require "fileutils"

# Find Rails root by walking upward looking for config/environment.rb
def find_rails_root
  dir = Dir.pwd
  while dir != "/"
    return dir if File.exist?(File.join(dir, "config", "environment.rb"))

    dir = File.dirname(dir)
  end
  nil
end

# Generate React on Rails packs if needed
def generate_packs_if_needed
  rails_root = find_rails_root
  return unless rails_root

  initializer_path = File.join(rails_root, "config", "initializers", "react_on_rails.rb")
  return unless File.exist?(initializer_path)

  # Check if auto-pack generation is configured
  initializer_content = File.read(initializer_path)
  return unless initializer_content.match?(/^\s*config\.auto_load_bundle\s*=/) ||
                initializer_content.match?(/^\s*config\.components_subdirectory\s*=/)

  puts "ğŸ“¦ Generating React on Rails packs..."

  Dir.chdir(rails_root) do
    # Skip validation during precompile hook execution
    ENV["REACT_ON_RAILS_SKIP_VALIDATION"] = "true"

    # Run pack generation
    system("bundle", "exec", "rails", "react_on_rails:generate_packs", exception: true)
    puts "âœ… Pack generation completed successfully"
  end
rescue Errno::ENOENT => e
  warn "âš ï¸  Warning: #{e.message}"
rescue StandardError => e
  warn "âŒ Pack generation failed: #{e.message}"
  exit 1
end

# Main execution
generate_packs_if_needed
