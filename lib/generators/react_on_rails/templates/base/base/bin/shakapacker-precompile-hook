#!/usr/bin/env ruby
# frozen_string_literal: true

# Shakapacker precompile hook for React on Rails
#
# This script runs before webpack compilation to generate pack files
# for auto-bundled components. It's called automatically by Shakapacker
# when configured in config/shakapacker.yml:
#   precompile_hook: 'bin/shakapacker-precompile-hook'
#
# Emoji Scheme:
#   ğŸ”„ = Running/in-progress
#   âœ… = Success
#   âŒ = Error

# Skip validation during precompile hook execution
# The hook runs early in the build process, potentially before full Rails initialization,
# and doesn't need package version validation since it's part of the build itself
ENV["REACT_ON_RAILS_SKIP_VALIDATION"] = "true"

require_relative "../config/environment"

begin
  puts Rainbow("ğŸ”„ Running React on Rails precompile hook...").cyan
  ReactOnRails::PacksGenerator.instance.generate_packs_if_stale
rescue StandardError => e
  warn Rainbow("âŒ Error in precompile hook: #{e.message}").red
  warn e.backtrace.first(5).join("\n")
  exit 1
end
